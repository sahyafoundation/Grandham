<!DOCTYPE html>
<html lang="ml">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Publishing Map | ‡¥ó‡µç‡¥∞‡¥®‡µç‡¥•‡¥Ç - Grandham</title>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #072A6C;
            --secondary-color: #E8505B;
            --accent-color: #F8B739;
            --text-dark: #2C3E50;
            --text-light: #ECF0F1;
            --bg-light: #F5F7FA;
        }

        body {
            font-family: 'Segoe UI', 'Nirmala UI', 'Manjari', 'Rachana', Arial, sans-serif;
            color: var(--text-dark);
            line-height: 1.6;
            overflow-x: hidden;
        }

        /* Navigation */
        nav {
            background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .nav-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--primary-color);
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .nav-links {
            display: flex;
            gap: 2rem;
            list-style: none;
        }

        .nav-links a {
            color: var(--text-dark);
            text-decoration: none;
            font-weight: 500;
            transition: color 0.3s ease;
            padding: 0.5rem 1rem;
            border-radius: 6px;
        }

        .nav-links a:hover,
        .nav-links a.active {
            color: var(--primary-color);
            background: var(--bg-light);
        }

        /* Header Section */
        .page-header {
            background: linear-gradient(135deg, var(--primary-color) 0%, #0a3d8f 100%);
            color: var(--text-light);
            padding: 3rem 2rem;
            text-align: center;
        }

        .page-header h1 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .page-header p {
            font-size: 1.1rem;
            opacity: 0.95;
        }

        /* Stats Section */
        .stats-container {
            background: var(--bg-light);
            padding: 2rem;
            display: flex;
            justify-content: center;
            gap: 3rem;
            flex-wrap: wrap;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .stat-box {
            text-align: center;
            padding: 1rem 2rem;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: transform 0.3s ease;
        }

        .stat-box:hover {
            transform: translateY(-5px);
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
        }

        .stat-label {
            font-size: 0.9rem;
            color: var(--text-dark);
            opacity: 0.8;
        }

        /* Map Container */
        .map-section {
            padding: 2rem;
            background: white;
            min-height: calc(100vh - 400px);
        }

        .map-container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .section-title {
            font-size: 2rem;
            color: var(--primary-color);
            margin-bottom: 1.5rem;
            text-align: center;
            font-weight: 600;
        }

        #map {
            height: 600px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.12);
            border: 2px solid var(--bg-light);
        }

        .map-disclaimer {
            max-width: 1400px;
            margin: 1rem auto;
            padding: 1rem;
            background: #FFF9E6;
            border-left: 4px solid var(--accent-color);
            border-radius: 6px;
            font-size: 0.9rem;
            color: var(--text-dark);
        }

        .map-disclaimer strong {
            color: var(--primary-color);
        }

        /* Loading Spinner */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 600px;
            flex-direction: column;
            gap: 1rem;
        }

        .spinner {
            border: 4px solid var(--bg-light);
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Custom Popup Styles */
        .leaflet-popup-content-wrapper {
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }

        .custom-popup {
            font-family: 'Segoe UI', 'Nirmala UI', 'Manjari', Arial, sans-serif;
            min-width: 250px;
        }

        .popup-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 0.8rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--accent-color);
        }

        .popup-info {
            font-size: 0.9rem;
            color: var(--text-dark);
            margin-top: 0.5rem;
            line-height: 1.8;
        }

        .book-list {
            max-height: 250px;
            overflow-y: auto;
            margin-top: 0.8rem;
            padding: 0.5rem;
            background: var(--bg-light);
            border-radius: 6px;
        }

        .book-item {
            padding: 0.5rem;
            margin-bottom: 0.5rem;
            background: white;
            border-radius: 4px;
            border-left: 3px solid var(--primary-color);
        }

        .book-item:last-child {
            margin-bottom: 0;
        }

        .book-title {
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 0.3rem;
            line-height: 1.4;
        }

        .book-author {
            font-size: 0.85rem;
            color: #555;
            margin-bottom: 0.3rem;
            font-style: italic;
        }

        .book-link {
            font-size: 0.85rem;
            color: var(--secondary-color);
            text-decoration: none;
        }

        .book-link:hover {
            text-decoration: underline;
        }

        /* Layer Control */
        .leaflet-control-layers {
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.15);
        }

        /* Footer */
        footer {
            background: var(--primary-color);
            color: var(--text-light);
            padding: 3rem 2rem 2rem;
            margin-top: 3rem;
        }

        .footer-content {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 3rem;
            margin-bottom: 2rem;
        }

        .footer-section h3 {
            margin-bottom: 1.5rem;
            font-size: 1.3rem;
            color: var(--accent-color);
        }

        .footer-section ul {
            list-style: none;
        }

        .footer-section li {
            margin-bottom: 0.8rem;
        }

        .footer-section a {
            color: var(--text-light);
            text-decoration: none;
            opacity: 0.9;
            transition: all 0.3s ease;
        }

        .footer-section a:hover {
            opacity: 1;
            color: var(--accent-color);
            padding-left: 5px;
        }

        .footer-section p {
            opacity: 0.9;
            line-height: 1.7;
        }

        .footer-bottom {
            text-align: center;
            padding-top: 2rem;
            border-top: 1px solid rgba(255,255,255,0.2);
            opacity: 0.8;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .page-header h1 {
                font-size: 2rem;
            }

            .nav-links {
                display: none;
            }

            .stats-container {
                gap: 1rem;
            }

            .stat-box {
                padding: 0.8rem 1.5rem;
            }

            #map {
                height: 450px;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav>
        <div class="nav-container">
            <a href="index.html" class="logo">
                <span>üìö</span>
                <span>‡¥ó‡µç‡¥∞‡¥®‡µç‡¥•‡¥Ç</span>
            </a>
            <ul class="nav-links">
                <li><a href="index.html">Home</a></li>
                <li><a href="index.html#features">Features</a></li>
                <li><a href="index.html#about">About</a></li>
                <li><a href="map.html" class="active">Explore Map</a></li>
                <li><a href="index.html#contribute">Contribute</a></li>
            </ul>
        </div>
    </nav>

    <!-- Page Header -->
    <header class="page-header">
        <h1>üìç Publishing Houses Map</h1>
        <p>Explore the geographical distribution of Malayalam book publishers across India</p>
    </header>

    <!-- Statistics -->
    <div class="stats-container">
        <div class="stat-box">
            <div class="stat-number" id="location-count">--</div>
            <div class="stat-label">Publishing Locations</div>
        </div>
        <div class="stat-box">
            <div class="stat-number" id="book-count">--</div>
            <div class="stat-label">Malayalam Books</div>
        </div>
        <div class="stat-box">
            <div class="stat-number" id="unique-publishers">--</div>
            <div class="stat-label">Unique Publishers</div>
        </div>
    </div>

    <!-- Map Section -->
    <section class="map-section">
        <div class="map-container">
            <div id="map">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Loading publishing locations from Wikidata...</p>
                </div>
            </div>
            <div class="map-disclaimer">
                <strong>Map Disclaimer:</strong> The boundaries shown on this map are as per the official position of the Government of India. The external boundaries and coastlines of India as depicted in this map are neither correct nor authentic. For authentic boundaries, please refer to maps published by the Survey of India.
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer>
        <div class="footer-content">
            <div class="footer-section">
                <h3>Grandham</h3>
                <p>
                    An open bibliography project documenting Malayalam literary heritage through
                    structured data and interactive visualizations.
                </p>
            </div>
            <div class="footer-section">
                <h3>Quick Links</h3>
                <ul>
                    <li><a href="#home">Home</a></li>
                    <li><a href="map.html">Map</a></li>
                    <li><a href="#about">About</a></li>
                </ul>
            </div>
            <div class="footer-section">
                <h3>Resources</h3>
                <ul>
                    <li><a href="https://www.wikidata.org" target="_blank">Wikidata</a></li>
                    <li><a href="https://query.wikidata.org" target="_blank">SPARQL Query Service</a></li>
                    <li><a href="https://www.wikidata.org/wiki/Wikidata:WikiProject_Books/en#Bibliographic_properties" target="_blank">Data Model</a></li>
                </ul>
            </div>
            <div class="footer-section">
                <h3>Community</h3>
                <ul>
                    <li><a href="#contribute">Contribute</a></li>
                    <li><a href="https://github.com/sahyafoundation/Grandham" target="_blank">GitHub Repository</a></li>
                    <li><a href="https://grandham.in" target="_blank">Grandham.in</a></li>
                </ul>
            </div>
        </div>
        <div class="footer-bottom">
            <p>
                Supported by <a href="https://sahya.org.in/" target="_blank" style="color: #F8B739;">Sahya Digital Conservation Foundation</a> |
                Data from <a href="https://www.wikidata.org" target="_blank" style="color: #F8B739;">Wikidata</a> |
                Open Source ‚Ä¢ Open Data ‚Ä¢ Open Knowledge
            </p>
        </div>
    </footer>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

    <script>
        // Modified SPARQL Query to get book details, author, publication date, and Wikisource index
        const sparqlQuery = `
SELECT DISTINCT ?book ?bookLabel ?author ?authorLabel ?indexPage ?pubDate ?location ?locationLabel ?geo
WHERE
{
  {?book wdt:P31 wd:Q3331189} UNION {?book wdt:P31 wd:Q28869365}.
  ?book wdt:P1957 ?indexPage;
        wdt:P407 wd:Q36236;
        wdt:P291 ?location.
  ?location wdt:P625 ?geo.
  OPTIONAL { ?book wdt:P577 ?pubDate. }
  OPTIONAL { ?book wdt:P50 ?author. }
  SERVICE wikibase:label { bd:serviceParam wikibase:language 'ml,en'.
    ?book rdfs:label ?bookLabel.
    ?location rdfs:label ?locationLabel.
    ?author rdfs:label ?authorLabel.
  }
} ORDER BY ?location ?pubDate ?bookLabel
        `.trim();

        // Wikidata SPARQL endpoint
        const endpointUrl = 'https://query.wikidata.org/sparql';

        // Initialize map
        let map;
        let markerCluster;
        let baseLayers = {};

        function initMap() {
            // Create map centered on India
            map = L.map('map').setView([20.5937, 78.9629], 5);

            // OpenStreetMap layer (default - shows international boundaries)
            const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                maxZoom: 18
            });

            // ESRI World Street Map (alternative)
            const esriLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}', {
                attribution: 'Tiles ¬© Esri',
                maxZoom: 18
            });

            // CartoDB Positron (clean alternative)
            const cartoDBLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                attribution: '¬© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors ¬© <a href="https://carto.com/attributions">CARTO</a>',
                maxZoom: 19
            });

            // Add default layer
            osmLayer.addTo(map);

            // Define base layers for layer control
            baseLayers = {
                "OpenStreetMap": osmLayer,
                "ESRI Street Map": esriLayer,
                "CartoDB Light": cartoDBLayer
            };

            // Add layer control
            L.control.layers(baseLayers).addTo(map);

            // Initialize marker cluster group
            markerCluster = L.markerClusterGroup({
                maxClusterRadius: 60,
                spiderfyOnMaxZoom: true,
                showCoverageOnHover: true,
                zoomToBoundsOnClick: true,
                disableClusteringAtZoom: 15
            });

            map.addLayer(markerCluster);

            // Add India boundary overlay (GeoJSON)
            addIndiaBoundary();
        }

        // Add India boundary overlay showing official boundaries
        async function addIndiaBoundary() {
            try {
                // Note: For production, you should host your own GeoJSON file with official boundaries
                // This is a placeholder - replace with official Survey of India approved boundaries
                const indiaGeoJSON = {
                    "type": "FeatureCollection",
                    "features": []
                    // In production, load from: your-server/india-official-boundary.geojson
                };

                // Add boundary layer with styling
                L.geoJSON(indiaGeoJSON, {
                    style: {
                        color: '#FF6600',
                        weight: 2,
                        opacity: 0.8,
                        fillOpacity: 0.05
                    }
                }).addTo(map);

            } catch (error) {
                console.log('India boundary overlay not available');
            }
        }

        // Fetch data from Wikidata
        async function fetchData() {
            try {
                const url = endpointUrl + '?query=' + encodeURIComponent(sparqlQuery);
                const response = await fetch(url, {
                    headers: {
                        'Accept': 'application/sparql-results+json'
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to fetch data from Wikidata');
                }

                const data = await response.json();
                return data.results.bindings;

            } catch (error) {
                console.error('Error fetching data:', error);
                document.getElementById('map').innerHTML =
                    '<div class="loading"><p style="color: #E8505B;">Error loading data. Please try again later.</p></div>';
                return [];
            }
        }

        // Extract year from date string
        function getYear(dateString) {
            if (!dateString) return null;
            const match = dateString.match(/^(\d{4})/);
            return match ? match[1] : null;
        }

        // Create custom icon
        function createCustomIcon() {
            return L.divIcon({
                html: `<div style="background-color: #072A6C; width: 35px; height: 35px; border-radius: 50% 50% 50% 0;
                       transform: rotate(-45deg); border: 3px solid white; box-shadow: 0 3px 10px rgba(0,0,0,0.4);
                       display: flex; align-items: center; justify-content: center;">
                       <span style="transform: rotate(45deg); color: white; font-size: 18px;">üìö</span>
                       </div>`,
                className: 'custom-marker',
                iconSize: [35, 35],
                iconAnchor: [17.5, 35],
                popupAnchor: [0, -35]
            });
        }

        // Add markers to map with clustering
        function addMarkersToMap(data) {
            const locations = new Map();

            // Group books by location
            data.forEach(item => {
                const coords = item.geo.value.match(/Point\(([-\d.]+) ([-\d.]+)\)/);
                if (coords) {
                    const lon = parseFloat(coords[1]);
                    const lat = parseFloat(coords[2]);
                    const locationId = item.location.value;
                    const locationName = item.locationLabel.value;
                    const bookId = item.book.value;
                    const bookLabel = item.bookLabel.value;
                    const indexPage = item.indexPage.value;
                    const pubYear = item.pubDate ? getYear(item.pubDate.value) : null;
                    const authorName = item.authorLabel ? item.authorLabel.value : null;

                    if (!locations.has(locationId)) {
                        locations.set(locationId, {
                            name: locationName,
                            lat: lat,
                            lon: lon,
                            books: []
                        });
                    }

                    locations.get(locationId).books.push({
                        id: bookId,
                        title: bookLabel,
                        index: indexPage,
                        year: pubYear,
                        author: authorName
                    });
                }
            });

            // Update statistics
            document.getElementById('location-count').textContent = locations.size;
            document.getElementById('book-count').textContent = data.length;
            document.getElementById('unique-publishers').textContent = locations.size;

            // Add markers with book information
            locations.forEach((location, id) => {
                const marker = L.marker([location.lat, location.lon], {
                    icon: createCustomIcon()
                });

                // Create book list HTML
                let bookListHTML = '';
                location.books.forEach((book, index) => {
                    if (index < 10) { // Show first 10 books
                        const titleWithYear = book.year ? `${book.title} (${book.year})` : book.title;
                        const authorDisplay = book.author ? `<div class="book-author">‚úçÔ∏è ${book.author}</div>` : '';

                        bookListHTML += `
                            <div class="book-item">
                                <div class="book-title">${titleWithYear}</div>
                                ${authorDisplay}
                                <a href="${book.id}" target="_blank" class="book-link">üìñ View on Wikidata</a> |
                                <a href="${book.index}" target="_blank" class="book-link">üìÑ Wikisource Index</a>
                            </div>
                        `;
                    }
                });

                if (location.books.length > 10) {
                    bookListHTML += `<div style="text-align: center; padding: 0.5rem; font-style: italic;">
                        ... and ${location.books.length - 10} more books
                    </div>`;
                }

                const popupContent = `
                    <div class="custom-popup">
                        <div class="popup-title">${location.name}</div>
                        <div class="popup-info">
                            üìö Total Books: <strong>${location.books.length}</strong>
                        </div>
                        <div class="book-list">
                            ${bookListHTML}
                        </div>
                    </div>
                `;

                marker.bindPopup(popupContent, {
                    maxWidth: 400,
                    className: 'custom-leaflet-popup'
                });

                markerCluster.addLayer(marker);
            });

            // Fit map to show all markers
            if (locations.size > 0) {
                const bounds = markerCluster.getBounds();
                map.fitBounds(bounds, {
                    padding: [50, 50],
                    maxZoom: 12
                });
            }
        }

        // Initialize everything
        async function init() {
            initMap();
            const data = await fetchData();
            if (data.length > 0) {
                addMarkersToMap(data);
            }
        }

        // Run on page load
        window.addEventListener('load', init);
    </script>
</body>
</html>
